version: "2.3"
services:
  nginx:
    image: atomgraph/nginx
    mem_limit: 128m
    command: /bin/bash -c "envsubst '$$UPSTREAM_SERVER $$UPSTREAM_HTTPS_PORT $$UPSTREAM_HTTP_PORT $$SERVER_NAME $$SERVER_HTTPS_PORT $$SERVER_HTTP_PORT' < /etc/nginx/nginx.conf.template > /etc/nginx/nginx.conf && nginx -g 'daemon off;'"
    ports:
      - ${HTTP_PORT}:${HTTP_PORT} # allow Tomcat to do HTTP to HTTPS redirect
      - ${HTTPS_PORT}:${HTTPS_PORT} # HTTPS
    environment:
      - UPSTREAM_SERVER=linkeddatahub
      - UPSTREAM_HTTPS_PORT=8443
      - UPSTREAM_HTTP_PORT=8080
      - SERVER_NAME=${HOST}
      - SERVER_HTTPS_PORT=${HTTPS_PORT}
      - SERVER_HTTP_PORT=${HTTP_PORT}
    volumes:
      - ./platform/nginx.conf.template:/etc/nginx/nginx.conf.template:ro
  linkeddatahub:
    image: atomgraph/linkeddatahub:latest
    environment:
      - CATALINA_OPTS=-XX:+UseContainerSupport -XX:MaxRAMPercentage=75 # heap will use up to 75% of container's RAM
      - ATOMGRAPH_UPLOAD_ROOT=/var/www/linkeddatahub/uploads/
      - TZ="Europe/Copenhagen"
      #- CATALINA_OPTS="-Duser.timezone=Europe/Copenhagen"
      - PROXY_HOST=nginx
      - PROTOCOL=${PROTOCOL}
      - HOST=${HOST}
      - ABS_PATH=${ABS_PATH}
      - PROXY_HTTP_PORT=${HTTP_PORT}
      - HTTP_REDIRECT_PORT=${HTTPS_PORT}
      - PROXY_HTTPS_PORT=${HTTPS_PORT}
      - HTTPS_CLIENT_AUTH=want
      - PKCS12_KEY_PASSWORD=R4#?CWaY#ZET\ncZ
      - PKCS12_STORE_PASSWORD=R4#?CWaY#ZET\ncZ
      - CLIENT_KEYSTORE_PASSWORD=LinkedDataHub
      - CLIENT_TRUSTSTORE_PASSWORD=LinkedDataHub
      - SELF_SIGNED_CERT=true # only on localhost
      - SIGN_UP_CERT_VALIDITY=180
      - IMPORT_KEEPALIVE=300000
      - MAIL_SMTP_HOST=email-server
      - MAIL_SMTP_PORT=25
      - MAIL_USER=linkeddatahub@localhost
      - OWNER_MBOX=${OWNER_MBOX}
      - OWNER_GIVEN_NAME=${OWNER_GIVEN_NAME}
      - OWNER_FAMILY_NAME=${OWNER_FAMILY_NAME}
      - OWNER_ORG_UNIT=${OWNER_ORG_UNIT}
      - OWNER_ORGANIZATION=${OWNER_ORGANIZATION}
      - OWNER_LOCALITY=${OWNER_LOCALITY}
      - OWNER_STATE_OR_PROVINCE=${OWNER_STATE_OR_PROVINCE}
      - OWNER_COUNTRY_NAME=${OWNER_COUNTRY_NAME}
      - OWNER_KEY_PASSWORD=${OWNER_KEY_PASSWORD}
    volumes:
      - ./certs:/usr/local/tomcat/webapps/ROOT/certs
      - ./uploads:/var/www/linkeddatahub/uploads
      - ./config/dev.log4j.properties:/usr/local/tomcat/webapps/ROOT/WEB-INF/classes/log4j.properties:ro
      - ./config/system.trig:/var/linkeddatahub/datasets/system.trig:ro
      - ./platform/datasets/admin.trig:/var/linkeddatahub/datasets/admin.trig:ro
      - ./platform/datasets/end-user.trig:/var/linkeddatahub/datasets/end-user.trig:ro
      - ./src/main/resources/com/atomgraph/linkeddatahub/apl.ttl:/usr/local/tomcat/webapps/ROOT/WEB-INF/classes/com/atomgraph/linkeddatahub/apl.ttl:ro
      - ./src/main/resources/com/atomgraph/linkeddatahub/aplt.ttl:/usr/local/tomcat/webapps/ROOT/WEB-INF/classes/com/atomgraph/linkeddatahub/aplt.ttl:ro
      - ./src/main/resources/com/atomgraph/linkeddatahub/lapp.ttl:/usr/local/tomcat/webapps/ROOT/WEB-INF/classes/com/atomgraph/linkeddatahub/lapp.ttl:ro
      - ./src/main/resources/com/atomgraph/linkeddatahub/app/admin/lsm.ttl:/usr/local/tomcat/webapps/ROOT/WEB-INF/classes/com/atomgraph/linkeddatahub/app/admin/lsm.ttl:ro
      - ./src/main/webapp/static/com/atomgraph/linkeddatahub/xsl/bootstrap/2.3.2:/usr/local/tomcat/webapps/ROOT/static/com/atomgraph/linkeddatahub/xsl/bootstrap/2.3.2:ro
      - ./src/main/webapp/static/com/atomgraph/linkeddatahub/css/bootstrap.css:/usr/local/tomcat/webapps/ROOT/static/com/atomgraph/linkeddatahub/css/bootstrap.css
      - ./src/main/webapp/static/com/atomgraph/linkeddatahub/js/jquery.js:/usr/local/tomcat/webapps/ROOT/static/com/atomgraph/linkeddatahub/js/jquery.js:ro
  fuseki-admin:
    image: atomgraph/fuseki
    ports:
      - 3030:3030
    volumes:
      - ./config/fuseki/admin.ttl:/var/fuseki/config.ttl:ro
      - ./data/admin:/var/fuseki/data
    command: [ "--config", "/var/fuseki/config.ttl" ]
  fuseki-end-user:
    image: atomgraph/fuseki
    ports:
      - 3031:3030
    volumes:
      - ./config/fuseki/end-user.ttl:/var/fuseki/config.ttl:ro
      - ./data/end-user:/var/fuseki/data
    command: [ "--config", "/var/fuseki/config.ttl" ]
  email-server:
    image: namshi/smtp
    environment:
      - DISABLE_IPV6=true